--Definimos el contexto
USE WAREHOUSE LYNX_WH;
USE DATABASE UCM;
USE SCHEMA SMART_DESK;

SHOW TABLES;


--EJERCICIO 1
--Analisis completo de ventas y beneficio por producto.

SELECT 
    CATEGORY,
    SUM (PRODUCT) AS TOTAL_PRODUCT,
    SUM (MAINTENANCE) AS TOTAL_MAINTANCE,
    SUM (PARTS) AS TOTAL_PARTS,
    SUM (SUPPORT) AS TOTAL_SUPORT,
    SUM (UNITS_SOLD) AS UNITS,
    SUM (PROFIT) AS TOTAL_PROFIT,
    ROUND(AVG(PROFIT),2) AS PROMEDIO_PROFIT
    
FROM SALES
WHERE YEAR = 2020 AND ACCOUNT='Abbot Industries'
GROUP BY CATEGORY;


--EJERCICIO 2
--Calculo del pronostico total y beneficio esperado

SELECT COALESCE (S.CATEGORY,F.CATEGORY) AS CATEGORY,
SUM(S.PROFIT) AS TOTAL_PROFIT,   
SUM (F.FORECAST_PROFIT) AS TOTAL_FORECAST ,
MAX(F.OPPORTUNITY_AGE) AS MAX_AGE, 
MIN(F.OPPORTUNITY_AGE) AS MIN_AGE
FROM SALES AS S
FULL OUTER JOIN FORECASTS AS F ON S.CATEGORY= F.CATEGORY AND S.YEAR= F.YEAR
WHERE (S.QUARTER_OF_YEAR = 'Q1' AND S.YEAR = 2020) OR (S.QUARTER_OF_YEAR = 'Q3' AND S.YEAR = 2021) OR F.YEAR=2022
GROUP BY COALESCE(S.CATEGORY, F.CATEGORY);




--EJERCICIO 3
-- Comparación de ventas, unidades vendidas y beneficio entre industrias en APAC y EMEA
SELECT A.INDUSTRY, A.REGION, 
       SUM(S.PRODUCT) AS TOTAL_PRODUCTOS, 
       SUM(S.UNITS_SOLD) AS UNITS, 
       SUM(PROFIT) AS TOTAL_PROFIT, 
       ROUND(AVG(PROFIT), 2) AS PROMEDIO_PROFIT
FROM SALES AS S
INNER JOIN ACCOUNTS AS A 
ON S.ACCOUNT = A.ACCOUNT
WHERE REGION IN ('APAC','EMEA')
GROUP BY A.INDUSTRY, A.REGION
ORDER BY A.REGION ASC, TOTAL_PROFIT DESC;





--EJERCICIO 4
--Beneficio por tipo de empresa

SELECT F.ACCOUNT, 
       SUM(F.FORECAST_PROFIT) AS TOTAL_FORECAST, 
       IFF(SUM(S.PROFIT) > 1000000, 'Alto', 'Normal') AS TIPO_DE_PROFIT
FROM FORECASTS F
INNER JOIN SALES S
ON F.ACCOUNT = S.ACCOUNT
GROUP BY F.ACCOUNT
HAVING TOTAL_FORECAST > 500000;



--EJERCICIO 5
--Beneficio acumulado por trimestre particionado por industria

SELECT S.CATEGORY, 
       QUARTER,
       PROFIT,
       FORECAST_PROFIT,
       SUM(PROFIT) OVER (PARTITION BY INDUSTRY ORDER BY QUARTER) AS TOTAL_PROFIT,
       SUM(FORECAST_PROFIT) OVER (PARTITION BY INDUSTRY ORDER BY QUARTER) AS TOTAL_FORECAST,
       OPPORTUNITY_AGE
FROM SALES S
JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
JOIN FORECASTS F ON F.ACCOUNT = S.ACCOUNT
ORDER BY S.CATEGORY, QUARTER;








-------CASO PRÁCTICO
--¿Que categoria ha experimentado la mayor rentabilidad en el año 2020?

SELECT CATEGORY, 
      SUM(PROFIT) AS TOTAL_PROFIT,
      SUM (TOTAL) AS TOTAL_INGRESOS,
      SUM(TOTAL) - TOTAL_PROFIT AS TOTAL_GASTO,
      TOTAL_PROFIT / TOTAL_GASTO AS INDICE_RENTABILIDAD
      
FROM SALES
WHERE YEAR =2020
GROUP BY CATEGORY
ORDER BY INDICE_RENTABILIDAD DESC;

